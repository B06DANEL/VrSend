<!DOCTYPE html>
<html>
<head>
    <title>WebXR Screen Share with Recenter & Mixed Reality Pass-through</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: 'Inter', sans-serif; background: #121212; color: #e0e0e0; margin:0; padding:2rem;
               display:flex; flex-direction: column; align-items:center; justify-content:center; min-height:100vh; text-align:center; }
        h1 { color:#fff; margin-bottom:2rem; }
        #selection, #sender, #receiver {
            display:flex; flex-direction:column; align-items:center; gap:1rem;
            background:#1e1e1e; padding:2rem; border-radius:1rem;
            box-shadow:0 8px 32px rgba(0,0,0,0.37); width:90%; max-width:500px; position:relative;
        }
        button { background:#03dac6; color:#000; border:none; padding:1rem 2rem;
                 font-size:1rem; font-weight:bold; border-radius:.5rem; cursor:pointer; transition:.3s; }
        button:hover { background:#018786; }
        button:disabled { background:#333; color:#888; cursor:not-allowed; }
        video { border-radius:.5rem; background:#000; width:100%; max-width:400px; }
        textarea { width:100%; min-height:100px; background:#2c2c2c; border:1px solid #444;
                   color:#e0e0e0; border-radius:.5rem; padding:.5rem; font-family:monospace; box-sizing:border-box; }
        .hidden { display:none; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <h1>WebXR Screen Share</h1>
    <div id="selection">
        <h2>Choose role:</h2>
        <button id="sendButton">Send Screen</button>
        <button id="receiveButton">Receive Screen</button>
    </div>

    <div id="sender" class="hidden">
        <h2>Sender</h2>
        <video id="localVideo" autoplay muted playsinline></video>
        <h3>Offer (SDP only):</h3>
        <textarea id="offerSdp" readonly></textarea>
        <h3>Paste Answer SDP:</h3>
        <textarea id="answerSdp"></textarea>
        <button id="setAnswerButton">Connect</button>
    </div>

    <div id="receiver" class="hidden">
        <h2>Receiver</h2>
        <p>Click on view to recenter the screen.</p>
        <video id="remoteVideo" autoplay playsinline class="hidden"></video>
        <h3>Paste Offer SDP:</h3>
        <textarea id="offerSdpInput"></textarea>
        <button id="createAnswerButton">Create Answer</button>
        <h3>Answer (SDP only):</h3>
        <textarea id="answerSdpOutput" readonly></textarea>
        <div id="vr-button-container"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        const configuration = { iceServers:[{urls:'stun:stun.l.google.com:19302'}] };
        let pc;

        // Sender
        document.getElementById('sendButton').onclick = async()=>{
            document.getElementById('selection').classList.add('hidden');
            document.getElementById('sender').classList.remove('hidden');
            try{
                const stream = await navigator.mediaDevices.getDisplayMedia({video:true});
                document.getElementById('localVideo').srcObject = stream;
                pc = new RTCPeerConnection(configuration);
                stream.getTracks().forEach(t=>pc.addTrack(t,stream));
                pc.onicecandidate = e=>{ if(!e.candidate) document.getElementById('offerSdp').value=pc.localDescription.sdp; };
                const offer = await pc.createOffer(); await pc.setLocalDescription(offer);
            }catch(err){ console.error(err); }
        };
        document.getElementById('setAnswerButton').onclick = async()=>{
            const sdp = document.getElementById('answerSdp').value.trim();
            if(!sdp) return alert('Paste answer SDP.');
            await pc.setRemoteDescription({type:'answer',sdp});
            document.getElementById('setAnswerButton').disabled=true;
        };

        // Receiver
        document.getElementById('receiveButton').onclick = ()=>{
            document.getElementById('selection').classList.add('hidden');
            document.getElementById('receiver').classList.remove('hidden');
            setupXR();
        };
        document.getElementById('createAnswerButton').onclick = async()=>{
            const sdpIn = document.getElementById('offerSdpInput').value.trim();
            if(!sdpIn) return alert('Paste offer SDP.');
            document.getElementById('remoteVideo').classList.remove('hidden');
            pc = new RTCPeerConnection(configuration);
            pc.ontrack = ev=>document.getElementById('remoteVideo').srcObject=ev.streams[0];
            pc.onicecandidate = e=>{ if(!e.candidate) document.getElementById('answerSdpOutput').value=pc.localDescription.sdp; };
            await pc.setRemoteDescription({type:'offer',sdp:sdpIn});
            const ans = await pc.createAnswer(); await pc.setLocalDescription(ans);
            document.getElementById('createAnswerButton').disabled=true;
        };

        // XR + recenter + MR pass-through
        async function setupXR(){
            let scene,camera,renderer,plane;
            // get camera feed for passthrough
            const camStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
            const camVideo = document.createElement('video'); camVideo.srcObject=camStream;
            camVideo.play();

            function init(){
                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.1,1000);

                // MR background sphere
                const sphereGeo = new THREE.SphereGeometry(10, 32,32);
                const camTex = new THREE.VideoTexture(camVideo);
                const sphereMat = new THREE.MeshBasicMaterial({map:camTex, side:THREE.BackSide});
                scene.add(new THREE.Mesh(sphereGeo, sphereMat));

                // main screen plane
                const vid = document.getElementById('remoteVideo');
                const vidTex = new THREE.VideoTexture(vid);
                const mat = new THREE.MeshBasicMaterial({map:vidTex});
                plane = new THREE.Mesh(new THREE.PlaneGeometry(6,3.375), mat);
                scene.add(plane);
                recenter(false);

                renderer = new THREE.WebGLRenderer({antialias:true,alpha:true});
                renderer.setSize(window.innerWidth,window.innerHeight);
                renderer.xr.enabled=true;
                document.getElementById('receiver').appendChild(renderer.domElement);

                // VR entry
                const cont = document.getElementById('vr-button-container');
                ['immersive-vr'].forEach(type=>{
                    const btn=document.createElement('button'); btn.textContent='Enter VR';
                    btn.onclick=()=>{
                        if(renderer.xr.isPresenting) renderer.xr.getSession().end();
                        else navigator.xr.requestSession(type,{optionalFeatures:['local-floor']}).then(s=>renderer.xr.setSession(s));
                    };
                    cont.appendChild(btn);
                });

                renderer.domElement.addEventListener('click',()=>recenter(true));
                window.addEventListener('resize',onResize);
                renderer.setAnimationLoop(()=>renderer.render(scene,camera));
            }
            function onResize(){ camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight); }
            function recenter(requireXR){ if(requireXR && !renderer.xr.isPresenting) return; const dir=new THREE.Vector3(); camera.getWorldDirection(dir);
                plane.position.copy(camera.position).add(dir.multiplyScalar(3)); plane.lookAt(camera.position);
            }
            if('xr' in navigator) navigator.xr.isSessionSupported('immersive-vr').then(s=>s?init():alert('VR not supported')); else alert('WebXR not available');
        }
    </script>
</body>
</html>
